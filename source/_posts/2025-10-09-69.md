---
title: Redis + Lua è„šæœ¬å®ç°è®¡æ•°å™¨é™æµ
date: 2025-10-09 21:59:00
categories: ["é»˜è®¤åˆ†ç±»"]
tags: []
---

# Redis + Lua è„šæœ¬å®ç°è®¡æ•°å™¨é™æµ
## é™æµ
ç³»ç»Ÿé«˜å¹¶å‘çš„ä¸‰å¤§ä¿éšœæœ‰ï¼šç¼“å­˜ã€é™çº§ã€**é™æµ** 
é™æµï¼šé™åˆ¶ç³»ç»Ÿæˆ–è€…æŸä¸ªæœåŠ¡åœ¨**å•ä½æ—¶é—´å†…å¤„ç†è¯·æ±‚çš„æ•°é‡**ï¼Œé˜²æ­¢ç³»ç»Ÿè¶…è´Ÿè·ï¼Œä¿éšœæœåŠ¡æ­£å¸¸è¿è¡Œã€‚å¸¸ç”¨ç®—æ³•æœ‰ï¼šè®¡æ•°å™¨ã€ä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶ç­‰ã€‚

é™æµä¸­çš„ä¸¤ä¸ªæ¦‚å¿µï¼š
- **é˜ˆå€¼**ï¼šæ¯”å¦‚å°†QPSé™åˆ¶ä¸º500ï¼Œé‚£ä¹ˆè¯´æ˜æ¯ç§’å¤„ç†500ä¸ªè¯·æ±‚ï¼Œé€šè¿‡è®¾ç½®é˜ˆå€¼ï¼Œæ§åˆ¶ç³»ç»Ÿè´Ÿè½½ï¼Œè¾¾åˆ°é˜²æ­¢è¶…è´Ÿè·çš„ç›®çš„ã€‚
- **æ‹’ç»ç­–ç•¥**ï¼šé‚£ä¹ˆè¢«é˜ˆå€¼æ‹’ä¹‹é—¨å¤–çš„è¯·æ±‚åº”è¯¥ä½œä½•å¤„ç†å‘¢ï¼Ÿæ‹’ç»ç­–ç•¥æä¾›äº†æ–¹æ¡ˆï¼Œå¸¸è§çš„æœ‰ï¼š
    - **ç›´æ¥æ‹’ç»**ï¼šç›´æ¥æ‹’ç»è¶…è¿‡é˜ˆå€¼çš„è¯·æ±‚ï¼Œä¸äºˆå¤„ç†ã€‚
    - **æ’é˜Ÿç­‰å¾…**ï¼šå°†è¶…è¿‡é˜ˆå€¼çš„è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œç­‰å€™å¤„ç†ã€‚
ä¸åŒä¸šåŠ¡åœºæ™¯ä¸‹é€‰æ‹©åˆé€‚çš„æ‹’ç»ç­–ç•¥èƒ½å¤Ÿæé«˜ç”¨æˆ·çš„ä½“éªŒã€‚

ç›®å‰æ¯”è¾ƒä¸»æµçš„ä¸¤ä¸ªé™æµæ–¹æ¡ˆ
- ç½‘å…³å±‚ï¼šé™æµåœ¨æ‰€æœ‰åº”ç”¨çš„å…¥å£å¤„ã€‚
- ä¸­é—´ä»¶é™æµï¼šé™æµä¿¡æ¯å­˜å‚¨åœ¨ä¸­é—´ä»¶ï¼ˆå¦‚Redisï¼‰ä¸­ï¼Œæ¯ä¸ªç»„ä»¶å¯ä»¥ä»æ­¤è·å¾—äº‹å®çš„é™æµä¿¡æ¯ï¼Œæ¥å†³å®šæ“ä½œã€‚

```
//è®¡æ•°å™¨é™æµç¤ºæ„
public class Limiter{
    private final int limit = 10;
    private final int timeWindow = 1000;
    private long time;
    private AtomicInteger reqCount = new AtomicInteger(0);
       
    public Limiter(){
        this.time = System.currentTimeMillis();
    }
    // æ¯æ¬¡è¯·æ±‚å‰ä½¿ç”¨
    public boolean limit(){
        long now = System.currentTimeMillis();
        if(now < time + timeWindow){
            reqCount.addAndGet(1);
            return reqCount.get() < limit;
        }else{
            // è¶…å‡ºæ—¶é—´çª—å£ï¼Œé‡æ–°è®¡æ•°
            time = now;
            reqCount = new AtomicInteger(0);
            return true;
        }
    }
}
```

## ä»€ä¹ˆæ˜¯Luaè„šæœ¬ï¼Ÿ
ä¸€ç§è½»é‡çº§ã€åµŒå…¥å¼è„šæœ¬è¯­è¨€ï¼Œå¸¸ç”¨æ¸¸æˆå¼€å‘ã€è„šæœ¬ç¼–ç¨‹å’ŒåµŒå…¥å¼ç³»ç»Ÿä¸­ã€‚Redisä»2.6å¼€å§‹æ”¯æŒLuaè„šæœ¬ï¼Œå¯ä»¥é€šè¿‡ EVAL å‘½ä»¤æ‰§è¡ŒLuaè„šæœ¬ï¼Œå®ç°åŸå­æ“ä½œï¼Œé¿å…å¤æ‚çš„å¤šæ­¥æ“ä½œã€‚
Luaè„šæœ¬ç±»ä¼¼äºMySQLçš„äº‹åŠ¡ï¼Œå­˜å‚¨ä¸€ç»„æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤è¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œå…·æœ‰**åŸå­æ€§**ï¼Œåœ¨å¼€å‘ä¸­ä½¿ç”¨ Lua è„šæœ¬ï¼Œå¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¸€æ®µ**å…·æœ‰ä¸šåŠ¡é€»è¾‘çš„ä»£ç å—**ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç”¨åˆ°åŸå­æ€§çš„ä¸€ç»„æ“ä½œï¼Œå¿…ç„¶æ˜¯ä¸šåŠ¡éœ€æ±‚ã€‚

Luaè„šæœ¬åœ¨Redisä¸­çš„å¥½å¤„ï¼š
- **åŸå­æ€§æ“ä½œ**
- **å‡å°‘ç½‘ç»œå¼€é”€**ï¼šä¸€æ¬¡æ€§ç»„è£…å¤šæ¡å‘½ä»¤ï¼Œå‡å°‘Redisé€šä¿¡å¼€é”€
- **ä¾¿åˆ©å¤æ‚æ“**ï¼šä½œå®ç°å¤æ‚æ“ä½œï¼ŒåŸæœ¬Rediså‘½ä»¤æ‰§è¡Œå¯èƒ½å¾ˆç¹ç

å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š
- **åˆ†å¸ƒå¼é”**ï¼šRedisson åˆ†å¸ƒå¼é”åº•å±‚å°±åŒ…æ‹¬Luaè„šæœ¬
- **è®¡æ•°å™¨é™æµ**ï¼šLuaè„šæœ¬å®ç°ç²¾ç¡®è®¡æ•°å™¨é™æµï¼Œé¿å…å¹¶å‘é—®é¢˜
- **å¤æ‚äº‹åŠ¡**ï¼šLuaè„šæœ¬å¤„ç†å¤šæ­¥äº‹åŠ¡ï¼Œä¿éšœæ“ä½œå®Œæ•´æ€§ã€‚

## é¡¹ç›®åº”ç”¨
åœ¨é¡¹ç›®ä¸­åº”ç”¨**Redis+Lua**è„šæœ¬å®ç°è®¡æ•°å™¨é™æµï¼Œé¿å…é¢‘ç¹ç­‰é‡å¤æˆ–è€…æ¶æ„çš„æäº¤ï¼Œå‡å°‘ç³»ç»Ÿçš„å¼‚å¸¸å‹åŠ›ã€‚æˆ‘ä»¬ä¸ä»…å®ç°é™æµï¼Œè¿˜åº”ç”¨**è‡ªå®šä¹‰æ³¨è§£** + **åˆ‡é¢**ï¼Œå®ç°çµæ´»çš„é™æµã€‚

### Lua è„šæœ¬é…ç½®
é¦–å…ˆå°†è„šæœ¬é…ç½®æ³¨å…¥
```
public class RedisRateLimiterConfig {
    @Bean
    public DefaultRedisScript<Long> limitScript() {
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(limitScriptText());
        redisScript.setResultType(Long.class);
        return redisScript;
    }
    /**
     * é™æµLuaè„šæœ¬ï¼ˆåŸºäºè®¡æ•°å™¨ç®—æ³•ï¼‰
     */
    private String limitScriptText() {
        return "local key = KEYS[1]\n" +
                "local count = tonumber(ARGV[1])\n" +
                "local time = tonumber(ARGV[2])\n" +
                "local current = redis.call('get', key)\n" +
                "if current and tonumber(current) > count then\n" +
                "    return tonumber(current)\n" +
                "end\n" +
                "current = redis.call('incr', key)\n" +
                "if tonumber(current) == 1 then\n" +
                "    redis.call('expire', key, time)\n" +
                "end\n" +
                "return tonumber(current)";
    }
}
```
Lua è„šæœ¬æµç¨‹ï¼š
1. è¯»å–keyè®¡æ•°
2. å¦‚æœkeyå­˜åœ¨ï¼Œä¸”å€¼è¶…è¿‡é™åˆ¶ï¼Œè¿”å›è®¡æ•°ï¼Œä»£è¡¨è¶…å‡ºé˜ˆå€¼
3. è®¡æ•°+1ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè®¡æ•°ä¼šè¢«è®¾ç½®ä¸º1
4. å¦‚æœè®¡æ•°==1ï¼Œæ„å‘³ç€æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
5. è¿”å›è®¡æ•°

### è‡ªå®šä¹‰æ³¨è§£
```
@Target(ElementType.METHOD) // è¡¨ç¤ºåªèƒ½ç”¨äºæ–¹æ³•
@Retention(RetentionPolicy.RUNTIME) // è¡¨ç¤ºè¿è¡Œæ—¶å­˜æ´»ï¼Œå¯è¢«åå°„è·å–
@Documented
public @interface RateLimiter {

    /**
     * é™æµkeyï¼ˆå‰ç¼€ï¼‰
     */
    String key() default "RATE_LIMIT:";

    /**
     * é™æµæ—¶é—´çª—å£ï¼Œå•ä½ç§’
     */
    int time() default 60;

    /**
     * é™æµæ¬¡æ•°
     */
    int count() default 100;

    /**
     * é™æµç±»å‹ï¼ˆé»˜è®¤/æŒ‰IPï¼‰
     */
    LimitType limitType() default LimitType.DEFAULT;
}
```

### åˆ‡é¢
```
private RedisTemplate<Object, Object> redisTemplate;
    private RedisScript<Long> limitScript;

    @Autowired
    public void setRedisTemplate(RedisTemplate<Object, Object> redisTemplate) {
        this.redisTemplate = redisTemplate;
    }

    @Autowired
    public void setLimitScript(RedisScript<Long> limitScript) {
        this.limitScript = limitScript;
    }

    @Before("@annotation(rateLimiter)")
    public void doBefore(JoinPoint point, RateLimiter rateLimiter) {
        int time = rateLimiter.time();
        int count = rateLimiter.count();
        String key = buildKey(rateLimiter, point);

        List<Object> keys = Collections.singletonList(key);
        Long current = redisTemplate.execute(limitScript, keys, count, time);

        if (current == null || current.intValue() > count) {
            throw new ServiceException("è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨å€™å†è¯•");
        }
        log.info("ğŸ”’ é™æµï¼škey={}, å½“å‰è¯·æ±‚æ¬¡æ•°={}, é™åˆ¶æ¬¡æ•°={}", key, current, count);
    }

    private String buildKey(RateLimiter rateLimiter, JoinPoint point) {
        StringBuilder sb = new StringBuilder(rateLimiter.key());
        if (rateLimiter.limitType() == LimitType.IP) {
            sb.append(IpUtils.getIpAddr(ServletUtils.getRequest())).append(":");
        }
        MethodSignature signature = (MethodSignature) point.getSignature();
        Method method = signature.getMethod();
        sb.append(method.getDeclaringClass().getName()).append(".").append(method.getName());
        return sb.toString();
    }
```
å®šä¹‰åˆ‡é¢ï¼Œæ‰§è¡Œå¸¦æœ‰@RateLimiteræ³¨è§£çš„æ–¹æ³•ä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡Œ doBeforeï¼ŒdoBeforeå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„é™æµé€»è¾‘ï¼š
1. ä»æ³¨è§£ratelimiterç±»è·å–é™æµé…ç½®ä¿¡æ¯ï¼ˆåº•å±‚æ˜¯åå°„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ**æ³¨è§£å‘¨æœŸè¦è®¾ç½®æˆè¿è¡Œæ—¶**ï¼‰
2. æ„é€ keyï¼Œè¿™é‡ŒåŠ å…¥IPæ¥æ„é€ ï¼Œå¹¶ä¸”é€šè¿‡**åå°„**è·å–æ–¹æ³•çš„æ‰€åœ¨ç±»å’Œæ–¹æ³•åï¼Œç»“åˆæ„é€ ï¼Œæœ€ç»ˆæ˜¯RATE_LIMIT:IP:com.example.test.login è¿™ç§å½¢å¼ï¼Œä»¥è¾¾åˆ°é™åˆ¶åŒä¸€IPè¯·æ±‚åŒä¸€æ–¹æ³•é¢‘ç‡çš„ç›®çš„ã€‚
3. æ‰§è¡ŒLuaè„šæœ¬é™æµé€»è¾‘ï¼Œå¦‚æœè¶…å‡ºé™åˆ¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

å¦‚ä½•åˆ†ææ”¹è¿›ç­–ç•¥ï¼Ÿ
- æŸæ¥å£é™æµæ¬¡æ•°å¾ˆå¤šï¼ˆä¾‹å¦‚ /login è¢«æ‹’ç»ä¸Šåƒæ¬¡ï¼‰
è¯´æ˜é™é¢å¤ªä½æˆ–æµé‡é«˜å³°æ˜æ˜¾
æé«˜ count æˆ–ç¼©çŸ­ time
- æŸäº› IP é¢‘ç¹è¢«é™æµ
è¯´æ˜æœ‰åˆ·æ¥å£é£é™©
å¯¹è¯¥ IP å•ç‹¬è®¾æ›´ä½é™é¢æˆ–æ‹‰é»‘
- æŸæ—¶æ®µï¼ˆæ¯”å¦‚ 9:00-9:30ï¼‰é™æµé›†ä¸­
è¯´æ˜ç³»ç»Ÿé«˜å³°æœŸ
è°ƒæ•´é™æµçª—å£ã€å¼•å…¥â€œåˆ†æ—¶æ®µåŠ¨æ€é™æµâ€
- é™æµæ¥å£éƒ½æ˜¯ä½ä»·å€¼æ¥å£ï¼ˆå¦‚ /pingï¼‰
è¯´æ˜èµ„æºæµªè´¹
å¯ä»¥æ”¾å®½æˆ–å–æ¶ˆé™æµ
- é™æµå¯¼è‡´ä¸»ä¸šåŠ¡æ¥å£å¤§é‡è¢«æ‹’ç»
è¯´æ˜ç­–ç•¥å¤ªæ¿€è¿›
è°ƒæ•´å…¨å±€é™é¢æˆ–ä½¿ç”¨ä»¤ç‰Œæ¡¶å¹³æ»‘é™æµ









