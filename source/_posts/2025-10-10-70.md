---
title: Redissonåˆ†å¸ƒå¼é”é¿å…é‡å¤æäº¤ä»»åŠ¡
date: 2025-10-10 16:03:27
categories: ["é»˜è®¤åˆ†ç±»"]
tags: []
---

# Redisson åˆ†å¸ƒå¼é”é¿å…é‡å¤æäº¤ä»»åŠ¡
## ä¸ºä»€ä¹ˆè¦å¼•å…¥ **åˆ†å¸ƒå¼é”** ï¼Ÿ
åœ¨æœ¬åœ°é”åœºæ™¯ä¸‹ï¼Œå·²ç»èƒ½å¤Ÿè§£å†³æœ¬åœ°æœåŠ¡ä¸‹å¤šçº¿ç¨‹ç«äº‰èµ„æºçš„åŒæ­¥é—®é¢˜ï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ä¸‹ï¼ŒæœåŠ¡Aå¯¹èµ„æºxåŠ é”ï¼Œè€ŒæœåŠ¡Bä¸å—æœåŠ¡Açš„é™åˆ¶ï¼Œè‹¥æ­¤æ—¶æœåŠ¡Bä¹Ÿå»è®¿é—®èµ„æºBï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå¯¼è‡´æœåŠ¡å‡ºé”™ã€‚
## åˆ†å¸ƒå¼é”
åˆ†å¸ƒå¼é”æ˜¯åˆ†å¸ƒå¼é›†ç¾¤åœºæ™¯ä¸‹å…±äº«çš„ä¸€ç§é”æœºåˆ¶ï¼Œä¿è¯äº†ä¸åŒæœåŠ¡ä¸‹çš„äº’æ–¥æ€§ï¼Œä»»æ„æ—¶åˆ»ï¼Œ**åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥æŒæœ‰é”**ã€‚
ç‰¹æ€§ï¼š
- **äº’æ–¥æ€§**ï¼šåŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥æŒæœ‰é”ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´å…·æœ‰äº’æ–¥æ€§ï¼Œå³ä¾¿æ˜¯è·¨æœåŠ¡ã€‚
- **è¶…æ—¶æœºåˆ¶**ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼ŒæŒæœ‰é”çš„å®¢æˆ·ç«¯æ‰§è¡Œå®Œæˆä¹‹åé‡Šæ”¾é”ï¼Œä½†æ˜¯å¦‚æœæ‰§è¡Œæ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´é”æ— æ³•æ­£ç¡®é‡Šæ”¾ï¼Œå°±ä¼šé€ æˆ**æ­»é”**ã€‚
ä¸ºäº†é˜²æ­¢æ­»é”ï¼Œéœ€è¦è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼Œè¶…æ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚
- **è‡ªåŠ¨ç»­æœŸ**ï¼šè¶…æ—¶æœºåˆ¶ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæŒæœ‰é”çš„å®¢æˆ·ç«¯åœ¨æ—¶é—´å†…æ— æ³•å®Œæˆä»»åŠ¡ï¼Œä¼šå¯¼è‡´ä»»åŠ¡è¿˜æ²¡å®Œæˆå°±é‡Šæ”¾é”ï¼Œè¿™ä¸æˆ‘ä»¬çš„åˆè¡·æ˜¯è¿èƒŒçš„ï¼ˆæˆ‘ä»¬å¼•å…¥è¶…æ—¶æœºåˆ¶å¹¶ä¸æ˜¯ä¸ºäº†é˜»ç¢æ­£å¸¸çš„ä»»åŠ¡å®Œæˆï¼Œè€Œæ˜¯ä¸ºäº†è§£å†³æ½œåœ¨æœåŠ¡å¼‚å¸¸é€ æˆçš„æ­»é”é—®é¢˜ï¼‰ï¼Œå› æ­¤ï¼Œéœ€è¦å¼•å…¥è‡ªåŠ¨ç»­æœŸæœºåˆ¶ã€‚
å¼€å¯ä¸€ä¸ª**ç›‘å¬ä»»åŠ¡**ï¼Œç›‘å¬çº¿ç¨‹ï¼Œå¦‚æœå®¢æˆ·ç«¯è¿˜å­˜æ´»å°±**å»¶é•¿**è¶…æ—¶æ—¶é—´ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è€…æ˜¯ä»»åŠ¡å¼‚å¸¸ã€‚

## å‡ ç§å®ç°æ–¹å¼
- æ•°æ®åº“
- Zookeeper
- Redis

å…¶ä¸­ï¼ŒRedis**æ€§èƒ½æœ€é«˜**ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯åˆ©ç”¨SetNXï¼ˆä½†æ˜¯æœ‰**æ­»é”é—®é¢˜**ï¼‰ï¼Œè€Œæ˜¯**Redisson** ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ã€‚

## å®ç°
### ç›´æ¥å®ç°
```
String lockKey = REVIEW_LOCK_PREFIX + taskId;
RLock lock = redissonCilent.getLock(lockKey);

try{
    // å°è¯•è·å–é”ï¼ˆæœ€å¤šç­‰å¾…2ç§’ï¼Œé”30ç§’åé‡Šæ”¾ï¼‰
    if(lock.tryLock(2, 30, TimeUnit.second){
        // ä»»åŠ¡æ‰§è¡Œé€»è¾‘
        // ...
    }else{
        log.info("ä»»åŠ¡ {} æ­£åœ¨è¢«å…¶ä»–äººå‘˜å¤„ç†ï¼Œè·³è¿‡æ­¤æ¬¡æäº¤", taskId);
    }
}catch(InterruptedException e){
    Thread.currentThread().interrupt();
    log.info("çº¿ç¨‹ç»ˆç«¯ï¼Œä»»åŠ¡ {} æ‰§è¡Œå¤±è´¥", taskId);
}catch(Exception e){
    log.info("ä»»åŠ¡ {} æ‰§è¡Œå¼‚å¸¸", taskId);
}finally{
    if(lock.isHeldByCurrentThread){
        lock.unlock();
        lock.info("å·²é‡Šæ”¾é” {}", lockKey);
    }
}
```
è¿™é‡Œå‡è®¾ä»»åŠ¡æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰åŠ å…¥é”ç»­æœŸæœºåˆ¶ï¼Œå¦‚æœè¦ç»­æœŸï¼Œä½¿ç”¨`lock.lock()`å¯ä»¥è‡ªåŠ¨å®ç°çœ‹é—¨ç‹—çš„ç»­æœŸæœºåˆ¶ã€‚

#### æ³¨è§£å¼éå…¥ä¾µå®ç°
ç›´æ¥å®ç°åˆ†å¸ƒå¼é”éœ€è¦å¯¹å…·ä½“æ–¹æ³•è¿›è¡Œä»£ç æ”¹åŠ¨ï¼Œå¦‚æœæˆ‘ä»¬å¼•å…¥æ³¨è§£æ¥å®ç°ï¼Œå¯ä»¥å®ç°**éå…¥ä¾µ**çš„åˆ†å¸ƒå¼é”å®ç°ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```
@DistributedLock(key = "#taskId", prefix = "precheck:", leaseTime = 30)
public void handlePrecheck(Long taskId){...}
```
åªéœ€è¦åœ¨æ–¹æ³•ä¹‹å‰åŠ ä¸Šè‡ªå®šä¹‰çš„åˆ†å¸ƒå¼é”æ³¨è§£ï¼Œä½¿ç”¨èµ·æ¥ååˆ†è½»ä¾¿ã€‚

```
ä¸šåŠ¡æ–¹æ³•ï¼ˆ@DistributedLockï¼‰
     â”‚
     â–¼
DistributedLockAspectï¼ˆAOPæ‹¦æˆªï¼‰
     â”‚
     â”œâ”€ è§£æ SpEL è¡¨è¾¾å¼ï¼Œå¾—åˆ°å®Œæ•´é” key
     â”‚
     â”œâ”€ è°ƒç”¨ IDistributedLock.tryLock(...)
     â”‚
     â”‚       â”‚
     â”‚       â–¼
     â”‚   RedissonDistributedLockï¼ˆå°è£… Redisson å®ç°ï¼‰
     â”‚       â”‚
     â”‚       â”œâ”€ è·å– RLock
     â”‚       â”œâ”€ æ‰§è¡Œ tryLock(...)
     â”‚       â”œâ”€ æˆåŠŸ â†’ new ILock(RLock, this)
     â”‚       â–¼
     â”‚   è¿”å› ILockï¼ˆå°è£…é”å¼•ç”¨ï¼‰
     â”‚
     â”œâ”€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ joinPoint.proceed()
     â”‚
     â”œâ”€ finallyï¼šlock.close()
     â”‚
     â”‚       â–¼
     â”‚   ILock.close()
     â”‚       â”‚
     â”‚       â””â”€ è°ƒç”¨ distributedLock.unlock(lock)
     â”‚
     â”‚              â”‚
     â”‚              â–¼
     â”‚        RedissonDistributedLock.unlock()
     â”‚              â”œâ”€ æ ¡éªŒçº¿ç¨‹æŒæœ‰é”
     â”‚              â””â”€ è°ƒç”¨ RLock.unlock()
     â–¼
   ğŸ”“ é”é‡Šæ”¾
```

é‚£ä¹ˆå¦‚ä½•å®ç°å‘¢ï¼Ÿ
1. å®šä¹‰æ³¨è§£@DistributedLock
    ```
    public @interface DistributedLock{
        String key(); 
        String prefix() default "lock:";
        long tryTime() default 30; // å°è¯•æ—¶é—´ï¼Œ30s
        long leaseTime() default 30; // é‡Šæ”¾æ—¶é—´ï¼Œ30s
        TimeUnit unit() default TimeUnit.Seconds; // æ—¶é—´å•ä½ï¼Œç§’
        boolean fair default false; // é»˜è®¤éå…¬å¹³é”
    }
    ```
2. ILock å°è£…é”é€»è¾‘ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰
    ```
    public class ILock implements AutoCloseable{
        private final Object lock;
        private IDistributedLock distributedLock; // å¯ä»¥é€‚åº”ä¸åŒçš„åˆ†å¸ƒå¼é”å®ç°
        
        @Override
        public void close() throws Exception{
            if(lock != null){
                distributedLock.unlock(lock);
            }
        }
    }
    ```
    ILock å°†é”çš„é€»è¾‘å°è£…ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„DistributedLockå®ç°ä¸åŒçš„é”ï¼ˆå¯ä»¥æ˜¯Redisã€Zookeeperï¼‰ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿå®ç°ä¸åŒçš„closeï¼Œå³ä¾¿æ˜¯ä¸åŒçš„åˆ†å¸ƒå¼é”ï¼Œcloseæ–¹æ³•éƒ½å°è£…åœ¨ILockä¸­ï¼Œä½¿ç”¨æ—¶æ— éœ€å…³å¿ƒå…·ä½“çš„æ˜¯ä»€ä¹ˆåˆ†å¸ƒå¼é”ï¼Œå®ç°äº†`ç­–ç•¥æ¨¡å¼`ã€‚
    ç»§æ‰¿AutoCloseableå¾ˆå…³é”®ï¼Œä½¿å¾— `try { ILock lock = distributedLock.tryLock(...); }` å…·å¤‡è‡ªåŠ¨é‡Šæ”¾èµ„æºçš„èƒ½åŠ›ï¼Œè€Œä¸ç”¨åœ¨finallyæ‰‹å†™èµ„æºé‡Šæ”¾closeã€‚
3. IDistributedLock åˆ†å¸ƒå¼é”æ“ä½œæ¥å£
    ```
    public interface IDistributedLock{
        ILock lock(String key, long leaseTime, TimeUnit unit, boolean fair);
        ILock tryLock(String key, long tryTime, long leaseTime, TimeUnit unit, boolean fair) throws Exception;
        void unlock(Object lock);
    }
    ```
4. RedissonDistributedLock å®ç° IDistributedLock æ¥å£
    ```
    public class RedissonDitributedLock implements IDistributedLock{
        @Resource
        RedissonClient redissonClient;
        
        @Override
        public ILock lock(String key, long leaseTime, TimeUnit unit, boolean fair){
            RLock lock = fair? redissonClient.getFairLock(key) : redissonClient.getLock(key);
            lock.lock(leaseTime, unit);
            return new ILock(lock, this);
        }
        
        @Override
        public ILock tryLock(String key, long tryTime, long leaseTime, TimeUnit unit, boolean fair){
            RLock lock = fair? redissonClient.getFairLock(key) : redissonClient.getLock(key);
            boolean acquired = lock.tryLock(tryTime, leaseTime, unit);
            if(acquired){
                return new ILock(lock, this);
            }
            return null;
        }
        
        @Override
        public void unlock(Object lock){
            if(lock instanceOf RLock){
                RLock rLock = (RLock) lock;
                try{
                    if(rLock.islocked() && rLock.isHeldByCurrentThread){
                        rLock.unlock();
                    }
                }catch(IllegalMonitorStateException e){
                    log.warn("åˆ†å¸ƒå¼é”é‡Šæ”¾å¤±è´¥ï¼š{}", e.getMessage());
                }
            } 
        }
    }
    ```
5.DistibutedLockAspect åˆ‡é¢
    ```
    public class DistributedLockAspect{
        
        @Resource
        private final IDistributedLock distributedLock;
        
        @around(@annoation(distributedLockAnno))
        private Object around(ProceedingJointPoint jointPoint, DistributedLock distributedLockAnno) throws Exception{
            String key = parseKey(jointPoint, distributedLockAnno);
            ILock lock = null;
            try{
                lock = distributedLock.tryLock(
                        key,
                        distributedLockAnno.tryTime(),
                        distributedLockAnno.leaseTime(),
                        distributedLockAnno.unit(),
                        distributedLockAnno.fair()        
                );
                if(lock == null){
                    log.warn("æœªèƒ½è·å–åˆ°é”, {}", key);
                    return null;
                }
                
                Object result = jointPoint.proceed(); // åŸæœ¬æ–¹æ³•æ‰§è¡Œçš„ç»“æœ
            } finally{
                if (lock != null) {
                    lock.close();
                    log.info("ğŸ”“ å·²é‡Šæ”¾é”ï¼š{}", key);
                }
            }

        }
        
        private String parseKey(ProceedingJoinPoint joinPoint, DistributedLock anno) {
            String spelKey = anno.key();
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            Method method = signature.getMethod();
            String[] paramNames = signature.getParameterNames();
            Object[] args = joinPoint.getArgs();

            EvaluationContext context = new StandardEvaluationContext();
            for (int i = 0; i < paramNames.length; i++) {
                context.setVariable(paramNames[i], args[i]);
            }

            Expression expression = parser.parseExpression(spelKey);
            Object value = expression.getValue(context);
            return anno.prefix() + Objects.toString(value);
        }
        
    }
    ```
    
æ•´ä½“æµç¨‹ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @DistributedLock(key="#id")â”‚  â† ä¸šåŠ¡æ–¹æ³•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
     [DistributedLockAspect]
             â”‚
             â–¼
     [IDistributedLock æ¥å£]
             â”‚
             â–¼
     [RedissonDistributedLock]
             â”‚
             â–¼
     [Redis å®ä¾‹]
```
